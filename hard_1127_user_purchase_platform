withdeviceas
（selectuser_id,spend_date,casewhencount(*)=1thenplatformelse'both'endplatform,sum(amount)amount
fromspendinggroupbyuser_id,spend_date）,
datesas
(
selectdistinctspend_date,'desktop'platformfromspending
unionall
selectdistinctspend_date,'mobile'platformfromspending
unionall
selectdistinctspend_date,'both'platformfromspending
)
selectc.spend_date,c.platform,sum(coalesce(amount,0))total_amount,sum(casewhenamountisnullthen0else1end)total_users
fromdatesc
leftjoindevicev
ondates.spend_date=device.spend_date
anddates.platform=device.platform